#!groovy
@Library('common-shared-libraries@master') _

pipeline{

    environment {
        registryUrl = "https://harbor.doxpert.co.kr"
        registry = "harbor.doxpert.co.kr/library/"
        application = "sample-master"
        tag = "latest"
        gitCredential = "git-credential"
        registryCredential = "harbor-registry-credential"
    }
    
    agent {
      kubernetes {
        defaultContainer 'jnlp'
        yamlFile 'JenkinsPod.yml'
      }
    }

    options {
        timeout(time: 20, unit: 'MINUTES')
    }

    stages{
        stage("SETUP"){
            steps{
                container('jnlp') {
                    setup()
                }
            }
        }
        stage("SOURCE TEST"){
            steps{
                container('maven') {
                    sourceTest('')
                }
            }
        }
        stage('SPRING BUILD') {
            steps{
                container('maven') {
                    sourceBuild("maven-jar")
                }
            }
        }
        stage("IMAGE BUILD AND PUSH"){
            steps{
                container('docker') {
                    dockerPush()
                }
            }
        }
        stage("DEPLOY"){
            steps{
                container('kubectl') {
                    deploy('k8s')
                }
            }
        }
        stage("BRANCH MERGE") {
            steps{
                gitMerge()
            }
        }
    }
    post{
        success { postEvent('success')}
        failure { postEvent('failure')}
    }
}